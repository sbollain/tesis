---
title: "CreacionDeEstructuras"
output:
  html_document:
    df_print: paged
---

Vamos a crear series temporales para cada parámetro y finalmente un dataframe con la estructura adecuada, una línea por cada observación

La librería que nos permite trabajar con series temporales con intervalos variables entre valores son "zoo" y"xts"
```{r}
library("xts")
```

Como sugerencia, usar el comando summary
para ver la lista de parámetros entre los 76 disponibles de los que hay datos:
```{r}
summary (mydata$parametro_id)
```

Identificamos para que parámetros hay valores y 
creamos todas las series temporales en un bucle
```{r}

for (i in 1:nrow (valores)){
        serie_d <- mydata[mydata$parametro_id==etiquetas[i],]
        cantidad <- nrow (mydata[mydata$parametro_id==etiquetas[i],])
        if ( cantidad > 0) {
                serie_d <- mydata[mydata$parametro_id==etiquetas[i],]
                serie_d <- data.frame(serie_d$fecha,serie_d$valor)
                colnames(serie_d) <- c("fecha","valor")
                
                print(paste("Hay", cantidad ,"valores de", (etiquetas[i]),"entre", serie_d$fecha[1], "y", serie_d$fecha[cantidad]))
                
                z.index <- round(serie_d$fecha,"secs")
                z.data <- serie_d$valor
                
                assign (etiquetas[i], zoo(z.data,z.index))
                
                rm (z.index)
                rm (z.data)
                rm (serie_d)
        }
        rm(cantidad)
        rm (i)
}
```





Finalmente, creamos los ficheros finales para el análisis
PENDIENTE COMPROBAR PRIMERO SI HAY DATOS
HAY QUE NORMALIZAR ADEMÁS LOS TIME STAMPS PARA EVITAR LLENAR EL DATAFRAME DE NAs
```{r}
Datos_ts <- merge.zoo (FR_PULSO,FCECG,SAT_O2,TAS,TAM,TAD,FR_RESPIRAT,FR_P,FR_E,ET_CO2,PTC_CO2,INS_CO2,PIP,PMVR,VTE,PS_VOL,COMPLIANZA,RESISTENCIA) 
```

Si queremos los datos sin NA:
```{r}
Datos_ts_interpolados <- na.approx(Datos_ts)
Datos_ts_interpolados <- na.omit(Datos_ts_interpolados)
```

Funcion para convertir una clase zoo en un dataframe
```{r}
zooToDf <- function(z) {
    df <- as.data.frame(z) 
    df$Date <- time(z) #create a Date column
    rownames(df) <- NULL #so row names not filled with dates
    df <- df[,c(ncol(df), 1:(ncol(df)-1))] #reorder columns so Date first
    return(df)
}
```

Y aquí tenemos nuestro dataframe
```{r}
Datos <- zooToDf(Datos_ts)
```

